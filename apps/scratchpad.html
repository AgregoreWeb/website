
<!DOCTYPE html>
<meta lang="en">
<meta charset="UTF-8">
<title>DWeb Scratchpad</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Quickly put together a p2p app with live preview">
<link rel="stylesheet" href="agregore://theme/style.css">
<link rel="stylesheet" href="browser://theme/style.css">
<style>
textarea {
  min-height: 25vh;
}
.closeButton {
  position: absolute;
  top: 2px;
  right: 2px;
}
form > *, label > * {
  display: block;
  margin: 0.5em;
}
h1 {
  font-size: 1rem;
  display: inline;
}
textarea, iframe {
  margin: 0px;
  display: block;
  width: 100%;
}
iframe {
  resize: vertical;
}
</style>
<header>
<h1>DWeb Scratchpad</h1>
  <button title="Save your scratchpad to the dweb" onclick="saveDialog.showModal()">üíæ</button>
  <button title="Load and edit a site from a link" onclick="loadDialog.showModal()">üìÇ</button>
  <button title="Look at your saved sites" onclick="window.showAllSaved()">üìÉ</button>
  <button title="Help" onclick="helpDialog.showModal()">‚ùî</button>
</header>
<main id="mainContents">

<iframe id="previewFrame"></iframe>
<textarea autofocus="" id="htmlContent">&lt;marquee&gt;üßë‚ÄçüíªHTML content hereüìÉ&lt;/marquee&gt;
</textarea>
<textarea id="cssContent">/*CSS here*/
marquee {
  color: var(--ag-theme-primary);
  font-weight: bold;
  font-size: 3em;
}
</textarea>
<textarea id="jsContent">// JavaScript here
console.log("Hello World!")
</textarea>

</main>
<dialog id="saveDialog">
<h2>Save to the dweb</h2>
<form id="saveForm">
  <label>
    Title
    <input id="appTitle" name="title" value="Scratchpad App">
  </label>
  <label>
    Filename (.html)
    <input id="appFilename" name="filename" value="example.html">
  </label>
  <label>
    Description
    <textarea id="appDescription" name="description">My quick scratch</textarea>
  </label>
  <label>
    Save Type
    <select name="saveType">
      <option value="hyper">hyper://</option>
      <option value="ipfs">ipfs://</option>
      <option value="ipns">ipns://</option>
      <option value="download">Download</option>
    </select>
  </label>
	<button>Save and View</button>
	</form>
  <button class="closeButton" title="Close dialog" onclick="this.parentElement.close()">‚ùå</button>
</dialog>
<dialog id="loadDialog">
  <form id="loadForm">
  <label>
    Page URL
    <input name="url" type="url">
    <button>Load üìÇ</button>
  </label>
  </form>
  <button class="closeButton" title="Close dialog" onclick="this.parentElement.close()">‚ùå</button>
</dialog>
<dialog id="helpDialog">
  <h2>How does this work?</h2>
  <p>
		This is a scratchpad for making p2p apps. Enter some HTML/CSS/JavaScript and see a preview in real time. You can save the result to your collection or try to load a site somebody else published from their link.
  </p>
  <p>
    If you're new to Agregore, check out our <a href="hyper://agregore.mauve.moe/docs/">docs</a> and if you're new to web programming check out the <a href="https://developer.mozilla.org/en-US/docs/Learn_web_development/Core">Mozilla Developer Network</a> for tutorials and documentation on web development.
  </p>
  <p>
    Once you've set up Ollama you can use the <a href="hyper://agregore.mauve.moe/docs/examples/quickcode.html">Quickcode</a> AI example to help generate code snippets for you. This can help you learn new syntax like "Css for a red box that is half the screen" or "open the camera and render the video to a video tag".
  </p>
  <p>
    If you feel like this page should have more features try opening it within itself and tinkering with the code!
  </p>
  <button class="closeButton" title="Close dialog" onclick="this.parentElement.close()">‚ùå</button>
</dialog>
<script type="module">
window.showAllSaved = async () => {
  const url = await getDriveURL()
  window.open(url)
}

const shouldLoad = new URL(location.href).searchParams.get('url')

// Triggered when we generate blobs for the page content
// FileReader converts them to data URLs
const previewReader = new FileReader()
previewReader.onload = (e) => previewFrame.src = e.target.result

let previewTimeout = null

mainContents.addEventListener('input', updatePreview)

loadForm.onsubmit = (e) => {
  e.preventDefault(e)
  console.log(loadForm)
  const url = new FormData(loadForm).get('url')
  loadPage(url)
  loadDialog.close()
}

saveForm.onsubmit = (e) => {
  e.preventDefault()
  const formData = new FormData(saveForm)
  saveDialog.close()
  let filename = formData.get('filename')
  if(!filename.endsWith('.html')) {
    filename+= '.html'
  }
  const saveType = formData.get('saveType')
  saveAndPublish(filename, saveType)
    .then((url) => window.open(url))
}

if(shouldLoad) {
  console.log("Loading", shouldLoad)
  loadPage(new URL(shouldLoad, location.href).href)
} else {
  setPreview(genPage())
}

function downloadDataUrl(dataUrl, filename) {
  const link = document.createElement('a');
  link.href = dataUrl;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

async function getDriveURL() {
  const name = "dweb_scratchpad"
  const response = await fetch(`hyper://localhost/?key=${name}`, { method: 'POST' });
  if (!response.ok) {
    throw new Error(`Failed to generate Hyperdrive key: ${response.statusText}`);
  }
  return await response.text()
}

async function getIPNSURL() {
  const name = "dweb_scratchpad"
  const response = await fetch(`ipns://localhost/?key=${name}`, { method: 'POST' });
  if (!response.ok) {
    throw new Error(`Failed to generate IPNS key: ${response.statusText}`);
  }
  await response.text()
  return response.headers.get('Location')
}

async function saveAndPublish(filename, saveType) {
  const content = genPage()

  if(saveType === 'download') {
    const url = previewFrame.src
    downloadDataUrl(url, filename)
    return url
  } else if(saveType === 'ipfs') {
    return saveIPFS(filename, content);
  } else if(saveType === 'ipns') {
    return saveIPNS(filename, content);
  } else {
    return saveHyper(filename, content);
  }
}

async function saveIPFS(filename, content) {
  const url = new URL(filename, 'ipfs://bafyaabakaieac/').href
  const response = await fetch(url, {
    method: 'PUT',
    body: content
  })
  if(!response.ok) {
    throw new Error(`Failed to upload ${await response.text()}`)
  }
  await response.text()
  return response.headers.get('Location')
}

async function saveHyper(filename, content) {
  const driveURL = await getDriveURL()
  const url = new URL(filename, driveURL).href
  const response = await fetch(url, {
    method: 'PUT',
    body: content
  })
  if(!response.ok) {
    throw new Error(`Failed to upload ${await response.text()}`)
  }
  await response.text()
  return url
}

async function saveIPNS(filename, content) {
  const rootURL = await getIPNSURL()
  const url = new URL(filename, rootURL).href
  const response = await fetch(url, {
    method: 'PUT',
    body: content
  })
  if(!response.ok) {
    throw new Error(`Failed to upload ${await response.text()}`)
  }
  await response.text()
  return url
}


function updatePreview() {
  if(previewTimeout) clearTimeout(previewTimeout)
  setTimeout(() => {
    setPreview(genPage())
  }, 4000)
}

async function setPreview(content) {
  const blob = new Blob([content], {type:"text/html"})
  previewReader.readAsDataURL(blob)
}

async function loadPage(url) {
  console.log('loading page', url)
  const response = await fetch(url)
  if(!response.ok) throw new Error(`Unable to load page:\n${await response.text()}`)
  const text = await response.text()
  const {title, description, html, js, css} = extractPage(text)
  console.log({title, description, html, js, css})

  const {pathname} = new URL(url)
  const filename = pathname.split('/').at(-1)

  appTitle.value = title
  appDescription.value = description
  appFilename.value = filename
  htmlContent.value = html
  cssContent.value = css
  jsContent.value = js

  setPreview(genPage())
}

function extractPage(content) {
  console.log('Extracting', {content})
  const parser = new DOMParser()
  const doc = parser.parseFromString(content, 'text/html');
  const title = doc.title
  const description = doc.head.querySelector('meta[name=description]').content.trim()
  const css = doc.head.querySelector('style').innerText.trim()
  const script = doc.head.querySelector('script') || doc.body.querySelector('script')
  const js = script.innerText.trim()

  for(const script of doc.querySelectorAll('script')) {
    script.parentElement.removeChild(script)
  }

  const html = doc.body.innerHTML.trim()

  return {title, description, css, html, js}
}

function genPage({
  title=appTitle.value,
  description=appDescription.value,
  html=htmlContent.value,
  css=cssContent.value,
  js=jsContent.value
}={}) {
return `
<!DOCTYPE html>
<meta lang="en">
<meta charset="UTF-8">
<title>${title}</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="${description.trim()}">
<link rel="stylesheet" href="agregore://theme/style.css">
<link rel="stylesheet" href="browser://theme/style.css">
<style>
${css}
</style>
${html}
<script type="module">
${js}
</${"script"}>
`
}
</script>
